<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phân Tích Dữ Liệu - Daniel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "Segoe UI", Arial, sans-serif;
        min-height: 100vh;
      }
      .navbar {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
      }
      .navbar-brand {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .main-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
      }
      .card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        background: white;
        margin-bottom: 30px;
        overflow: hidden;
      }
      .card-header {
        background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
        color: white;
        padding: 25px;
        text-align: center;
        border-bottom: none;
      }
      .card-header h2 {
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
      }
      .card-body {
        padding: 40px;
      }
      .table-actions {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .btn-group {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .btn {
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 500;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }
      .btn i {
        font-size: 1.1rem;
      }
      .btn-add-row {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        color: white;
        border: none;
      }
      .btn-add-row:hover {
        background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
        transform: translateY(-2px);
      }
      .btn-paste {
        background: linear-gradient(135deg, #f57c00 0%, #fb8c00 100%);
        color: white;
        border: none;
      }
      .btn-paste:hover {
        background: linear-gradient(135deg, #fb8c00 0%, #ffa726 100%);
        transform: translateY(-2px);
      }
      .btn-danger {
        background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
        color: white;
        border: none;
      }
      .btn-danger:hover {
        background: linear-gradient(135deg, #d32f2f 0%, #e53935 100%);
        transform: translateY(-2px);
      }
      .btn-analyze {
        background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);
        color: white;
        border: none;
      }
      .btn-analyze:hover {
        background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
        transform: translateY(-2px);
      }
      .divider {
        width: 2px;
        height: 24px;
        background: #e0e0e0;
        margin: 0 10px;
      }
      .table-container {
        background: white;
        border-radius: 15px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin: 20px 0;
        overflow: hidden;
      }
      .excel-table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Segoe UI", Arial, sans-serif;
      }
      .excel-table th {
        background: #f8f9fa;
        color: #1a237e;
        font-weight: 600;
        padding: 15px;
        text-align: center;
        border: 1px solid #e0e0e0;
        font-size: 1.1rem;
      }
      .excel-table td {
        border: 1px solid #e0e0e0;
        padding: 0;
        height: 40px;
        text-align: center;
      }
      .excel-table input {
        width: 100%;
        height: 100%;
        border: none;
        padding: 8px 12px;
        font-size: 1rem;
        transition: all 0.2s ease;
      }
      .excel-table input:focus {
        outline: none;
        background: #e3f2fd;
        box-shadow: inset 0 0 0 2px #1976d2;
      }
      .result-section {
        background: #ffffff;
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e0e0;
      }
      .result-section h4 {
        color: #1a237e;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e3f2fd;
      }
      .alert {
        border: none;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        font-size: 1.1rem;
      }
      .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .alert-danger {
        background: #fbe9e7;
        color: #d32f2f;
      }
      .alert-warning {
        background: #fff3e0;
        color: #f57c00;
      }
      .error-row {
        background: #fbe9e7;
      }
      .success-row {
        background: #e8f5e9;
      }
      .selected-row {
        background-color: #e3f2fd;
      }
      .selected-row input {
        background-color: #e3f2fd;
      }
      @media (max-width: 768px) {
        .card-body {
          padding: 20px;
        }
        .table-actions {
          padding: 15px;
        }
        .btn {
          width: 100%;
          justify-content: center;
        }
        .divider {
          width: 100%;
          height: 1px;
          margin: 10px 0;
        }
      }
      .navbar .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
      }
      .navbar-nav {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        display: flex;
        align-items: center;
      }
      .nav-link {
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="/">Daniel</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle active"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-tools"></i> Tools
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="/number-analysis">
                    <i class="fas fa-calculator"></i> Phân Tích Dãy Số</a
                  >
                </li>
                <li>
                  <a class="dropdown-item active" href="/data-analysis">
                    <i class="fas fa-table"></i> Phân Tích Dữ Liệu</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="/pdf-analysis">
                    <i class="fas fa-file-pdf"></i> Phân Tích PDF</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="/archive">
                    <i class="fas fa-archive"></i> PDF Archive</a
                  >
                </li>
                {% if session.get('username') == 'daniel' %}
                <li>
                  <a class="dropdown-item" href="/history">
                    <i class="fas fa-history"></i> History</a
                  >
                </li>
                {% endif %}
              </ul>
            </li>
            {% if session.get('username') == 'daniel' %}
            <li class="nav-item">
              <a class="nav-link" href="/admin">
                <i class="fas fa-user-shield"></i> Admin
              </a>
            </li>
            {% endif %}
            <li class="nav-item">
              <a class="nav-link" href="/logout">
                <i class="fas fa-sign-out-alt"></i> Log out
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <div class="card">
        <div class="card-header">
          <h2>Phân Tích Dữ Liệu</h2>
        </div>
        <div class="card-body">
          <div class="table-actions">
            <div class="btn-group">
              <button class="btn btn-add-row" onclick="addRow('main')">
                <i class="fas fa-plus"></i> Add
              </button>
              <button class="btn btn-danger" onclick="deleteSelectedRow()">
                <i class="fas fa-trash"></i> Delete
              </button>
              <button
                class="btn btn-paste"
                onclick="pasteFromClipboard('main')"
              >
                <i class="fas fa-paste"></i> Paste
              </button>
            </div>
            <div class="divider"></div>
            <div class="btn-group">
              <button class="btn btn-danger" onclick="clearTable('main')">
                <i class="fas fa-trash"></i> Clear
              </button>
              <button class="btn btn-analyze" onclick="analyzeData()">
                <i class="fas fa-calculator"></i> Count
              </button>
              <button class="btn btn-analyze" onclick="checkContinuity()">
                <i class="fas fa-link"></i> Check
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="excel-table" id="mainTable">
              <thead>
                <tr>
                  <th style="width: 60px">STT</th>
                  <th>MEAS</th>
                  <th>C/NO</th>
                  <th>CTNs</th>
                  <th>Size</th>
                </tr>
              </thead>
              <tbody id="mainTableBody">
                <!-- Dữ liệu sẽ được thêm vào đây -->
              </tbody>
            </table>
          </div>

          <div id="result" class="mt-4" style="display: none">
            <div class="result-section">
              <h4>Kết quả phân tích</h4>
              <div id="analysisResult"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Khởi tạo bảng với một số dòng mặc định
      function initializeTables() {
        for (let i = 0; i < 5; i++) {
          addRow("main");
        }
      }

      // Thêm dòng mới vào bảng
      function addRow(side) {
        const tbody = document.getElementById(side + "TableBody");
        const selectedRow = tbody.querySelector(".selected-row");
        const rowCount = tbody.children.length;
        const row = document.createElement("tr");

        // STT
        const sttCell = document.createElement("td");
        sttCell.textContent = rowCount + 1;
        row.appendChild(sttCell);

        // Input cells
        ["meas", "cno", "ctns", "size"].forEach((_, index) => {
          const cell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.className = "form-control";

          // Add click event for row selection
          cell.addEventListener("click", (e) =>
            handleRowSelection(e, side + "TableBody")
          );

          // Add paste event handler
          input.addEventListener("paste", async function (e) {
            e.preventDefault();
            try {
              const text = e.clipboardData.getData("text");

              if (side === "continuity") {
                await pasteFromClipboard("continuity");
              } else {
                const rows = text
                  .split(/\r\n|\r|\n/)
                  .filter((row) => row.trim());

                // Lấy vị trí của ô hiện tại
                const currentRow = this.closest("tr");
                const tbody = currentRow.closest("tbody");

                // Xóa nội dung cũ của bảng
                tbody.innerHTML = "";

                // Xử lý từng dòng dữ liệu
                rows.forEach((row, index) => {
                  const columns = row.split("\t");

                  if (columns.length >= 5) {
                    if (side === "main") {
                      const newRow = addRow(side);
                      const inputs = newRow.querySelectorAll("input");
                      if (columns[0])
                        inputs[0].value = columns[0]
                          .replace(/^"|"$/g, "")
                          .trim(); // MEAS
                      if (columns[1])
                        inputs[1].value = columns[1]
                          .replace(/^"|"$/g, "")
                          .trim(); // C/NO
                      if (columns[2])
                        inputs[2].value = columns[2]
                          .replace(/^"|"$/g, "")
                          .trim(); // CTN
                      if (columns[4])
                        inputs[3].value = columns[4]
                          .replace(/^"|"$/g, "")
                          .trim(); // SIZE
                    }
                  }
                });

                // Cập nhật số thứ tự
                updateRowNumbers(tbody);
              }
            } catch (err) {
              console.error("Paste error:", err);
              alert("Có lỗi xảy ra khi paste dữ liệu");
            }
          });

          cell.appendChild(input);
          row.appendChild(cell);
        });

        // Insert after selected row or append to end
        if (selectedRow) {
          selectedRow.insertAdjacentElement("afterend", row);
          updateRowNumbers(tbody);
        } else {
          tbody.appendChild(row);
        }

        return row;
      }

      // Hàm cập nhật số thứ tự
      function updateRowNumbers(tbody) {
        Array.from(tbody.children).forEach((row, index) => {
          row.firstElementChild.textContent = index + 1;
        });
      }

      // Xóa tất cả dữ liệu trong bảng
      function clearTable(side) {
        const tbody = document.getElementById(side + "TableBody");
        tbody.innerHTML = "";
        addRow(side); // Thêm một dòng trống
      }

      // Dán dữ liệu từ clipboard
      async function pasteFromClipboard(side) {
        try {
          const text = await navigator.clipboard.readText();
          const rows = text.split(/\r\n|\r|\n/).filter((row) => row.trim()); // Lọc các dòng trống
          const tbody = document.getElementById(side + "TableBody");
          tbody.innerHTML = "";

          let currentRow = null;
          let currentInputs = null;

          rows.forEach((row, index) => {
            const columns = row.split("\t");

            // Nếu dòng có đủ cột hoặc là dòng đầu tiên
            if (columns.length >= 5 || !currentRow) {
              if (side === "main") {
                addRow(side);
                currentRow = tbody.lastElementChild;
                currentInputs = currentRow.querySelectorAll("input");

                if (columns[0])
                  currentInputs[0].value = columns[0]
                    .replace(/^"|"$/g, "")
                    .trim(); // MEAS
                if (columns[1])
                  currentInputs[1].value = columns[1]
                    .replace(/^"|"$/g, "")
                    .trim(); // C/NO
                if (columns[2])
                  currentInputs[2].value = columns[2]
                    .replace(/^"|"$/g, "")
                    .trim(); // CTN
                if (columns[4])
                  currentInputs[3].value = columns[4]
                    .replace(/^"|"$/g, "")
                    .trim(); // SIZE
              } else if (side === "continuity") {
                const newRow = addContinuityRow();
                const inputs = newRow.querySelectorAll("input");
                if (columns[1])
                  inputs[0].value = columns[1].replace(/^"|"$/g, "").trim(); // C/NO
                if (columns[4])
                  inputs[1].value = columns[4].replace(/^"|"$/g, "").trim(); // SIZE
              }
            } else {
              // Nếu dòng không đủ cột, giả định đây là phần tiếp theo của C/NO
              if (currentInputs && currentInputs[1]) {
                const existingValue = currentInputs[1].value;
                const newValue = columns[0].replace(/^"|"$/g, "").trim();
                currentInputs[1].value = existingValue + "," + newValue;
              }
            }
          });

          // Cập nhật số thứ tự
          updateRowNumbers(tbody);
        } catch (err) {
          console.error("Paste error:", err);
          alert(
            "Không thể truy cập clipboard. Vui lòng kiểm tra quyền truy cập."
          );
        }
      }

      // Đếm số lượng số trong một chuỗi có dạng "1-5,7-10,19,21"
      function countNumbers(str) {
        if (!str) return 0;

        let count = 0;
        const parts = str.split(",");

        parts.forEach((part) => {
          part = part.trim();
          if (part.includes("-")) {
            // Xử lý dải số (vd: "1-5")
            const [start, end] = part.split("-").map((num) => parseInt(num));
            if (!isNaN(start) && !isNaN(end)) {
              count += end - start + 1;
            }
          } else {
            // Xử lý số đơn lẻ
            if (part && !isNaN(parseInt(part))) {
              count++;
            }
          }
        });

        return count;
      }

      // Lấy dữ liệu từ bảng
      function getTableData(side) {
        const tbody = document.getElementById(side + "TableBody");
        const data = [];

        tbody.querySelectorAll("tr").forEach((row, index) => {
          const inputs = row.querySelectorAll("input");
          const cno = inputs[1].value.trim(); // C/NO
          const ctns = inputs[2].value.trim(); // CTNs

          if (cno || ctns) {
            // Chỉ xử lý các dòng có dữ liệu
            const cnoCount = countNumbers(cno);

            data.push({
              rowIndex: index + 1,
              cno: cno,
              ctns: ctns,
              cnoCount: cnoCount,
              ctnsValue: parseInt(ctns) || 0,
            });
          }
        });
        return data;
      }

      // Phân tích dữ liệu
      function analyzeData() {
        const tbody = document.getElementById("mainTableBody");
        const data = [];
        let hasError = false;

        tbody.querySelectorAll("tr").forEach((row) => {
          const inputs = row.querySelectorAll("input");
          const size = inputs[3].value.trim(); // Size
          const cno = inputs[1].value.trim(); // C/NO
          const ctns = inputs[2].value.trim(); // CTNs

          if (cno || ctns) {
            const cnoCount = countNumbers(cno);
            const ctnsValue = parseInt(ctns) || 0;
            const status = cnoCount === ctnsValue ? "Khớp" : "Không khớp";

            if (cnoCount !== ctnsValue) {
              hasError = true;
            }

            data.push({
              size: size,
              cnoCount: cnoCount,
              ctnsValue: ctnsValue,
              status: status,
            });
          }
        });

        // Hiển thị kết quả
        const resultDiv = document.getElementById("result");
        resultDiv.style.display = "block";

        if (data.length === 0) {
          resultDiv.className = "alert alert-warning mt-4";
          document.getElementById("analysisResult").innerHTML =
            "Không có dữ liệu để phân tích";
        } else {
          // Tạo bảng kết quả
          let tableHtml = `
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Size</th>
                    <th>C/NO</th>
                    <th>CTNs</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

          data.forEach((row) => {
            const statusClass =
              row.status === "Khớp" ? "text-success" : "text-danger";
            tableHtml += `
              <tr>
                <td>${row.size}</td>
                <td>${row.cnoCount}</td>
                <td>${row.ctnsValue}</td>
                <td class="${statusClass} fw-bold">${row.status}</td>
              </tr>
            `;
          });

          tableHtml += `
                </tbody>
              </table>
            </div>
          `;

          // Thêm thông báo tổng quan
          const totalRows = data.length;
          const matchedRows = data.filter(
            (row) => row.status === "Khớp"
          ).length;
          const summaryHtml = `
            <div class="mb-3">
              <strong>Tổng số dòng:</strong> ${totalRows}<br>
              <strong>Số dòng khớp:</strong> ${matchedRows}<br>
              <strong>Số dòng không khớp:</strong> ${totalRows - matchedRows}
            </div>
          `;

          document.getElementById("analysisResult").innerHTML =
            summaryHtml + tableHtml;

          // Xác định màu thông báo
          if (!hasError) {
            resultDiv.className = "alert alert-success mt-4"; // Tất cả đúng
          } else if (matchedRows === 0) {
            resultDiv.className = "alert alert-danger mt-4"; // Tất cả sai
          } else {
            resultDiv.className = "alert alert-warning mt-4"; // Một số đúng, một số sai
          }
        }
      }

      // Kiểm tra tính liên tục
      function checkContinuity() {
        const mainTableRows =
          document.getElementById("mainTableBody").children.length;

        // Tạo modal cho bảng kiểm tra tính liên tục
        if (!document.getElementById("continuityModal")) {
          const modalHtml = `
            <div class="modal fade" id="continuityModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Kiểm Tra Tính Liên Tục</h5>
                    <small class="text-white-50 ms-2">(Press ESC to close)</small>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="table-container">
                      <table class="excel-table" id="continuityTable">
                        <thead>
                          <tr>
                            <th style="width: 60px">STT</th>
                            <th>Dãy Số</th>
                            <th>Size</th>
                          </tr>
                        </thead>
                        <tbody id="continuityTableBody">
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem;">
                    <div class="btn-group" style="gap: 10px;">
                      <button type="button" class="btn btn-add-row" onclick="addContinuityRow()">
                        <i class="fas fa-plus"></i> Add
                      </button>
                      <button type="button" class="btn btn-danger" onclick="deleteSelectedContinuityRow()">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                      <button type="button" class="btn btn-paste" onclick="pasteFromClipboard('continuity')">
                        <i class="fas fa-paste"></i> Paste
                      </button>
                    </div>
                    <div class="btn-group" style="gap: 10px;">
                      <button type="button" class="btn btn-danger" onclick="clearContinuityTable()">
                        <i class="fas fa-trash"></i> Clear
                      </button>
                      <button type="button" class="btn btn-primary" onclick="analyzeContinuity()">
                        <i class="fas fa-check"></i> Check
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        // Xóa và tạo lại các dòng trong bảng tính liên tục nếu bảng trống
        const continuityBody = document.getElementById("continuityTableBody");
        if (!continuityBody.children.length) {
          // Thêm số dòng tương ứng với bảng chính
          for (let i = 0; i < mainTableRows; i++) {
            const row = document.createElement("tr");

            // STT
            const sttCell = document.createElement("td");
            sttCell.textContent = i + 1;
            sttCell.addEventListener("click", (e) =>
              handleRowSelection(e, "continuityTableBody")
            );
            row.appendChild(sttCell);

            // Ô nhập dãy số
            const inputCell = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.className = "form-control";

            // Thêm sự kiện click cho cả cell và input
            inputCell.addEventListener("click", (e) =>
              handleRowSelection(e, "continuityTableBody")
            );
            input.addEventListener("click", (e) => {
              e.stopPropagation(); // Ngăn sự kiện click lan ra cell
              handleRowSelection(e, "continuityTableBody");
            });

            // Thêm sự kiện paste cho input
            input.addEventListener("paste", async function (e) {
              e.preventDefault();
              try {
                const text = e.clipboardData.getData("text");
                await pasteFromClipboard("continuity");
              } catch (err) {
                console.error("Paste error:", err);
                alert("Có lỗi xảy ra khi paste dữ liệu");
              }
            });

            inputCell.appendChild(input);
            row.appendChild(inputCell);

            // Thêm ô Size
            const sizeCell = document.createElement("td");
            const sizeInput = document.createElement("input");
            sizeInput.type = "text";
            sizeInput.className = "form-control";

            // Thêm sự kiện click cho cả cell và input
            sizeCell.addEventListener("click", (e) =>
              handleRowSelection(e, "continuityTableBody")
            );
            sizeInput.addEventListener("click", (e) => {
              e.stopPropagation(); // Ngăn sự kiện click lan ra cell
              handleRowSelection(e, "continuityTableBody");
            });

            // Thêm sự kiện paste cho ô Size
            sizeInput.addEventListener("paste", async function (e) {
              e.preventDefault();
              try {
                const text = e.clipboardData.getData("text");
                await pasteFromClipboard("continuity");
              } catch (err) {
                console.error("Paste error:", err);
                alert("Có lỗi xảy ra khi paste dữ liệu");
              }
            });

            sizeCell.appendChild(sizeInput);
            row.appendChild(sizeCell);

            continuityBody.appendChild(row);
          }
        }

        // Hiển thị modal
        const modal = new bootstrap.Modal(
          document.getElementById("continuityModal")
        );
        modal.show();
      }

      // Hàm xóa dữ liệu bảng kiểm tra tính liên tục
      function clearContinuityTable() {
        const inputs = document.querySelectorAll("#continuityTableBody input");
        inputs.forEach((input) => {
          input.value = "";
        });
      }

      // Hàm phân tích tính liên tục
      function analyzeContinuity() {
        const mainData = [];
        const continuityData = [];
        let hasError = false;
        let messages = [];
        let hasDuplicateError = false;
        let duplicateMessages = [];
        let totalRows = 0;
        let errorRows = 0;
        let sizeMismatchMessages = [];

        // Thu thập dữ liệu từ bảng chính
        document.querySelectorAll("#mainTableBody tr").forEach((row, index) => {
          const inputs = row.querySelectorAll("input");
          const cno = inputs[1].value.trim();
          const size = inputs[3].value.trim();
          if (cno || size) {
            mainData.push({
              rowIndex: index + 1,
              numbers: cno,
              size: size,
            });
          }
        });

        // Thu thập dữ liệu từ bảng kiểm tra tính liên tục
        document
          .querySelectorAll("#continuityTableBody tr")
          .forEach((row, index) => {
            const inputs = row.querySelectorAll("input");
            const numbers = inputs[0].value.trim();
            const size = inputs[1].value.trim();
            if (numbers || size) {
              continuityData.push({
                rowIndex: index + 1,
                numbers: numbers,
                size: size,
              });
            }
          });

        // Kiểm tra từng dòng
        mainData.forEach((mainRow, index) => {
          const continuityRow = continuityData[index];
          if (continuityRow) {
            totalRows++;
            let hasRowError = false;

            // Kiểm tra khớp Size
            if (mainRow.size !== continuityRow.size) {
              sizeMismatchMessages.push(
                `Dòng ${mainRow.rowIndex}: Phát hiện size ${mainRow.size} không khớp với size ${continuityRow.size}`
              );
              hasRowError = true;
              errorRows++;
            } else {
              // Chỉ kiểm tra tính liên tục nếu Size khớp
              const seq1 = parseNumberSequence(mainRow.numbers);
              const seq2 = parseNumberSequence(continuityRow.numbers);

              // Kiểm tra số trùng trong dãy số thứ nhất
              const duplicates1 = findDuplicates(seq1);
              if (duplicates1.length > 0) {
                hasDuplicateError = true;
                hasRowError = true;
                duplicateMessages.push(
                  `Size ${
                    mainRow.size
                  } - Dãy số thứ nhất có số trùng: ${duplicates1.join(", ")}`
                );
              }

              // Kiểm tra số trùng trong dãy số thứ hai
              const duplicates2 = findDuplicates(seq2);
              if (duplicates2.length > 0) {
                hasDuplicateError = true;
                hasRowError = true;
                duplicateMessages.push(
                  `Size ${
                    mainRow.size
                  } - Dãy số thứ hai có số trùng: ${duplicates2.join(", ")}`
                );
              }

              // Kiểm tra số trùng giữa hai dãy
              const duplicatesBetween = findDuplicatesBetweenArrays(seq1, seq2);
              if (duplicatesBetween.length > 0) {
                hasDuplicateError = true;
                hasRowError = true;
                duplicateMessages.push(
                  `Size ${
                    mainRow.size
                  } - Số trùng giữa hai dãy: ${duplicatesBetween.join(", ")}`
                );
              }

              // Kiểm tra tính liên tục nếu không có số trùng
              if (
                duplicates1.length === 0 &&
                duplicates2.length === 0 &&
                duplicatesBetween.length === 0
              ) {
                const result = checkSequenceContinuity(seq1, seq2);
                if (!result.continuous) {
                  hasError = true;
                  hasRowError = true;
                  messages.push(`Size ${mainRow.size}: ${result.message}`);
                } else {
                  messages.push(`Size ${mainRow.size}: ${result.message}`);
                }
              }
            }

            if (hasRowError) {
              errorRows++;
            }
          }
        });

        // Hiển thị kết quả
        const resultDiv = document.getElementById("result");
        resultDiv.style.display = "block";

        if (totalRows === 0) {
          resultDiv.className = "alert alert-warning mt-4";
          document.getElementById("analysisResult").innerHTML =
            "Không có dữ liệu để phân tích";
        } else {
          let finalMessage = "";

          // Hiển thị thông báo về Size không khớp nếu có
          if (sizeMismatchMessages.length > 0) {
            finalMessage +=
              `<strong>Size không khớp:</strong><br>` +
              sizeMismatchMessages.join("<br>") +
              "<br><br>";
          }

          // Hiển thị thông báo về số trùng nếu có
          if (hasDuplicateError) {
            finalMessage +=
              `<strong>Phát hiện số trùng:</strong><br>` +
              duplicateMessages.join("<br>") +
              "<br><br>";
          }

          // Hiển thị kết quả kiểm tra tính liên tục
          if (messages.length > 0) {
            finalMessage +=
              `<strong>Kết quả kiểm tra tính liên tục:</strong><br>` +
              messages.join("<br>");
          }

          document.getElementById("analysisResult").innerHTML = finalMessage;

          // Xác định màu thông báo
          if (errorRows === 0) {
            resultDiv.className = "alert alert-success mt-4"; // Tất cả đúng
          } else if (errorRows === totalRows) {
            resultDiv.className = "alert alert-danger mt-4"; // Tất cả sai
          } else {
            resultDiv.className = "alert alert-warning mt-4"; // Một số đúng, một số sai
          }
        }
      }

      // Hàm tìm số trùng trong một dãy số
      function findDuplicates(numbers) {
        const seen = new Set();
        const duplicates = new Set();

        numbers.forEach((num) => {
          if (seen.has(num)) {
            duplicates.add(num);
          } else {
            seen.add(num);
          }
        });

        return Array.from(duplicates).sort((a, b) => a - b);
      }

      // Chuyển đổi dãy số thành mảng các số
      function parseNumberSequence(str) {
        if (!str) return [];

        const numbers = [];
        const parts = str.split(",");

        parts.forEach((part) => {
          part = part.trim();
          if (part.includes("-")) {
            const [start, end] = part.split("-").map((num) => parseInt(num));
            if (!isNaN(start) && !isNaN(end)) {
              for (let i = start; i <= end; i++) {
                numbers.push(i);
              }
            }
          } else {
            const num = parseInt(part);
            if (!isNaN(num)) {
              numbers.push(num);
            }
          }
        });

        return numbers.sort((a, b) => a - b);
      }

      // Kiểm tra tính liên tục của hai dãy số
      function checkSequenceContinuity(seq1, seq2) {
        // Gộp hai dãy số và sắp xếp
        const allNumbers = [...new Set([...seq1, ...seq2])].sort(
          (a, b) => a - b
        );

        if (allNumbers.length === 0)
          return { continuous: false, message: "Không có dữ liệu" };

        // Kiểm tra tính liên tục
        for (let i = 1; i < allNumbers.length; i++) {
          if (allNumbers[i] - allNumbers[i - 1] > 1) {
            return {
              continuous: false,
              message: `Không liên tục tại ${allNumbers[i - 1]} và ${
                allNumbers[i]
              }`,
              min: allNumbers[0],
              max: allNumbers[allNumbers.length - 1],
            };
          }
        }

        return {
          continuous: true,
          message: `Liên tục từ ${allNumbers[0]} đến ${
            allNumbers[allNumbers.length - 1]
          }`,
          min: allNumbers[0],
          max: allNumbers[allNumbers.length - 1],
        };
      }

      // Hàm tìm số trùng giữa hai mảng
      function findDuplicatesBetweenArrays(arr1, arr2) {
        const set1 = new Set(arr1);
        return arr2.filter((num) => set1.has(num)).sort((a, b) => a - b);
      }

      // Thêm dòng mới vào bảng kiểm tra tính liên tục
      function addContinuityRow() {
        const tbody = document.getElementById("continuityTableBody");
        const selectedRow = tbody.querySelector(".selected-row");
        const rowCount = tbody.children.length;
        const row = document.createElement("tr");

        // STT
        const sttCell = document.createElement("td");
        sttCell.textContent = rowCount + 1;
        row.appendChild(sttCell);

        // Sequence input
        const inputCell = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control";

        // Add click event for row selection
        inputCell.addEventListener("click", (e) =>
          handleRowSelection(e, "continuityTableBody")
        );
        input.addEventListener("click", (e) => {
          e.stopPropagation(); // Ngăn sự kiện click lan ra cell
          handleRowSelection(e, "continuityTableBody");
        });

        // Add paste event handler
        input.addEventListener("paste", async function (e) {
          e.preventDefault();
          try {
            const text = e.clipboardData.getData("text");
            await pasteFromClipboard("continuity");
          } catch (err) {
            console.error("Paste error:", err);
            alert("Có lỗi xảy ra khi paste dữ liệu");
          }
        });

        inputCell.appendChild(input);
        row.appendChild(inputCell);

        // Size input
        const sizeCell = document.createElement("td");
        const sizeInput = document.createElement("input");
        sizeInput.type = "text";
        sizeInput.className = "form-control";

        // Thêm sự kiện click cho cả cell và input
        sizeCell.addEventListener("click", (e) =>
          handleRowSelection(e, "continuityTableBody")
        );
        sizeInput.addEventListener("click", (e) => {
          e.stopPropagation(); // Ngăn sự kiện click lan ra cell
          handleRowSelection(e, "continuityTableBody");
        });

        // Thêm sự kiện paste cho ô Size
        sizeInput.addEventListener("paste", async function (e) {
          e.preventDefault();
          try {
            const text = e.clipboardData.getData("text");
            await pasteFromClipboard("continuity");
          } catch (err) {
            console.error("Paste error:", err);
            alert("Có lỗi xảy ra khi paste dữ liệu");
          }
        });

        sizeCell.appendChild(sizeInput);
        row.appendChild(sizeCell);

        // Insert after selected row or append to end
        if (selectedRow) {
          selectedRow.insertAdjacentElement("afterend", row);
          updateRowNumbers(tbody);
        } else {
          tbody.appendChild(row);
        }

        return row;
      }

      // Hàm xóa dòng được chọn trong bảng kiểm tra tính liên tục
      function deleteSelectedContinuityRow() {
        deleteSelectedRows("continuityTableBody");
      }

      // Hàm xóa dòng được chọn
      function deleteSelectedRow() {
        deleteSelectedRows("mainTableBody");
      }

      // Add new function for multi-select functionality
      function handleRowSelection(event, tableId) {
        const tbody = document.getElementById(tableId);
        const clickedRow = event.target.closest("tr");

        if (!clickedRow) return;

        if (event.shiftKey) {
          // Shift + Click: Select range
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const lastSelectedRow = tbody.querySelector(".selected-row");

          if (lastSelectedRow) {
            const start = rows.indexOf(lastSelectedRow);
            const end = rows.indexOf(clickedRow);
            const [min, max] = [start, end].sort((a, b) => a - b);

            // Xóa selection cũ
            rows.forEach((row) => {
              row.classList.remove("selected-row");
              row.querySelectorAll("input").forEach((input) => {
                input.classList.remove("selected-row");
              });
            });

            // Thêm selection mới
            rows.forEach((row, index) => {
              if (index >= min && index <= max) {
                row.classList.add("selected-row");
                row.querySelectorAll("input").forEach((input) => {
                  input.classList.add("selected-row");
                });
              }
            });
          } else {
            clickedRow.classList.add("selected-row");
            clickedRow.querySelectorAll("input").forEach((input) => {
              input.classList.add("selected-row");
            });
          }
        } else if (event.ctrlKey || event.metaKey) {
          // Ctrl/Cmd + Click: Toggle selection
          clickedRow.classList.toggle("selected-row");
          clickedRow.querySelectorAll("input").forEach((input) => {
            input.classList.toggle("selected-row");
          });
        } else {
          // Normal click: Single selection
          tbody.querySelectorAll("tr").forEach((row) => {
            row.classList.remove("selected-row");
            row.querySelectorAll("input").forEach((input) => {
              input.classList.remove("selected-row");
            });
          });
          clickedRow.classList.add("selected-row");
          clickedRow.querySelectorAll("input").forEach((input) => {
            input.classList.add("selected-row");
          });
        }
      }

      // Update addRow function to support insertion after selected row
      function addRow(side) {
        const tbody = document.getElementById(side + "TableBody");
        const selectedRow = tbody.querySelector(".selected-row");
        const rowCount = tbody.children.length;
        const row = document.createElement("tr");

        // STT
        const sttCell = document.createElement("td");
        sttCell.textContent = rowCount + 1;
        row.appendChild(sttCell);

        // Input cells
        ["meas", "cno", "ctns", "size"].forEach((_, index) => {
          const cell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.className = "form-control";

          // Add click event for row selection
          cell.addEventListener("click", (e) =>
            handleRowSelection(e, side + "TableBody")
          );

          // Add paste event handler
          input.addEventListener("paste", async function (e) {
            e.preventDefault();
            try {
              const text = e.clipboardData.getData("text");

              if (side === "continuity") {
                await pasteFromClipboard("continuity");
              } else {
                const rows = text
                  .split(/\r\n|\r|\n/)
                  .filter((row) => row.trim());

                // Lấy vị trí của ô hiện tại
                const currentRow = this.closest("tr");
                const tbody = currentRow.closest("tbody");

                // Xóa nội dung cũ của bảng
                tbody.innerHTML = "";

                // Xử lý từng dòng dữ liệu
                rows.forEach((row, index) => {
                  const columns = row.split("\t");

                  if (columns.length >= 5) {
                    if (side === "main") {
                      const newRow = addRow(side);
                      const inputs = newRow.querySelectorAll("input");
                      if (columns[0])
                        inputs[0].value = columns[0]
                          .replace(/^"|"$/g, "")
                          .trim(); // MEAS
                      if (columns[1])
                        inputs[1].value = columns[1]
                          .replace(/^"|"$/g, "")
                          .trim(); // C/NO
                      if (columns[2])
                        inputs[2].value = columns[2]
                          .replace(/^"|"$/g, "")
                          .trim(); // CTN
                      if (columns[4])
                        inputs[3].value = columns[4]
                          .replace(/^"|"$/g, "")
                          .trim(); // SIZE
                    }
                  }
                });

                // Cập nhật số thứ tự
                updateRowNumbers(tbody);
              }
            } catch (err) {
              console.error("Paste error:", err);
              alert("Có lỗi xảy ra khi paste dữ liệu");
            }
          });

          cell.appendChild(input);
          row.appendChild(cell);
        });

        // Insert after selected row or append to end
        if (selectedRow) {
          selectedRow.insertAdjacentElement("afterend", row);
          updateRowNumbers(tbody);
        } else {
          tbody.appendChild(row);
        }

        return row;
      }

      // Helper function for main table paste
      function handleMainTablePaste(rows, input) {
        const currentRow = input.closest("tr");
        const tbody = currentRow.closest("tbody");
        let targetRow = currentRow;

        rows.forEach((row, index) => {
          const columns = row.split("\t");

          if (index === 0) {
            // Fill current row
            const inputs = targetRow.querySelectorAll("input");
            if (columns[0]) inputs[0].value = columns[0].trim();
            if (columns[1]) inputs[1].value = columns[1].trim();
            if (columns[2]) inputs[2].value = columns[2].trim();
            if (columns[4]) inputs[3].value = columns[4].trim();
          } else {
            // Create new row for additional data
            const newRow = addRow("main");
            const inputs = newRow.querySelectorAll("input");
            if (columns[0]) inputs[0].value = columns[0].trim();
            if (columns[1]) inputs[1].value = columns[1].trim();
            if (columns[2]) inputs[2].value = columns[2].trim();
            if (columns[4]) inputs[3].value = columns[4].trim();
          }
        });

        updateRowNumbers(tbody);
      }

      // Update delete functions to handle multiple selections
      function deleteSelectedRows(tableId) {
        const tbody = document.getElementById(tableId);
        const selectedRows = tbody.querySelectorAll(".selected-row");

        if (selectedRows.length > 0) {
          selectedRows.forEach((row) => row.remove());
          updateRowNumbers(tbody);
        } else {
          alert("Vui lòng chọn một hoặc nhiều dòng để xóa");
        }
      }

      // Khởi tạo bảng khi trang được tải
      document.addEventListener("DOMContentLoaded", function () {
        initializeTables();

        // Khởi tạo tooltips
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Thêm xử lý phím tắt cho toàn bộ trang
        document.addEventListener("keydown", function (event) {
          // Kiểm tra nếu đang focus vào input
          const activeElement = document.activeElement;
          const isInputFocused = activeElement.tagName === "INPUT";

          // Xử lý phím Enter
          if (event.key === "Enter") {
            // Nếu modal kiểm tra tính liên tục đang mở
            const continuityModal = document.getElementById("continuityModal");
            if (continuityModal && continuityModal.classList.contains("show")) {
              analyzeContinuity();
              return;
            }

            // Nếu không, thực hiện phân tích dữ liệu
            if (isInputFocused) {
              analyzeData();
            }
          }

          // Xử lý phím Escape
          if (event.key === "Escape") {
            // Nếu modal kiểm tra tính liên tục đang mở
            const continuityModal = document.getElementById("continuityModal");
            if (continuityModal && continuityModal.classList.contains("show")) {
              const modal = bootstrap.Modal.getInstance(continuityModal);
              modal.hide();
              return;
            }

            // Nếu đang focus vào input, blur input đó
            if (isInputFocused) {
              activeElement.blur();
            }
          }
        });

        // Thêm tooltip cho các nút
        const analyzeBtn = document.querySelector(".btn-analyze");
        if (analyzeBtn) {
          analyzeBtn.title = "Nhấn Enter để thực thi";
        }

        const closeBtn = document.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) {
          closeBtn.title = "Nhấn ESC để đóng";
        }
      });
    </script>
  </body>
</html>
